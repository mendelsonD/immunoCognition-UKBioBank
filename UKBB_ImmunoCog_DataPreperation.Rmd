---
title: "UKBB_ImmunoCog_Analysis"
author: "Daniel Mendelson"
date: "22/02/2022"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(stringr)
library(dplyr)
library(tidyr)
library(arsenal)
library(reticulate)
library(psych)
library(lubridate)
library(glue)
library(knitr)
library(finalfit)
library(Hmisc)
library(DescTools)
library(coin)
library(esc)
library(effsize)
knitr::knit_engines$set(python = reticulate::eng_python)
reticulate::virtualenv_create(envname = "myreticulate", python = "/usr/bin/python3.8", packages = "pandas")

```

# 0 - Functions

## Assumption checks

### Normality

```{r normalityCheck, echo=FALSE}
numNotFactor <- function(x){
  if(is.numeric(x) == TRUE && is.factor(x) == FALSE && is.logical(x) == FALSE){
          return(x)
  }
} # This function is made to be used by mapply(). 'x' - a column from a df.

normalCheck <- function(x, colName, colNum){
  plotList <- c()
  
  degFree <- length(x)
  skew <- skew(x)
  se_skew <- skew/length(x)
  t_skew <- skew/se_skew
  p_skew <- pt(q = abs(t_skew), df = degFree, lower.tail = F)
  skewReport <- paste("skew=", round(skew, 2), "(t=", format(round(t_skew, 2), scientific = T), ", p=", format(round(p_skew, 2), scientific = T), ")")
    
  kurt <- kurtosi(x)
  se_kurt <- sqrt(24/degFree)
  t_kurt <- kurt/se_kurt
  p_kurt <- pt(q = abs(t_kurt), df = degFree, lower.tail = F)
  kurtReport <- paste("kurt=", round(kurt, 2), "(t=", format(round(t_kurt, 2), scientific = T), ", p=", format(round(p_kurt, 2), scientific = T), ")")
  
  layout(matrix(c(1,2), ncol = 2, nrow = 1))
  hist <- hist(x, xlab = "",main = paste("Hist - ", colNum, colName), sub = paste("colNum: ", colNum, skewReport, "\n", "colNum: ", colNum, kurtReport))
  qqplot <- qqnorm(x, main = paste("QQplot - ", colNum, colName))
  qqline(x)
  iPlots <- list(hist, qqplot)
  plotList <- append(plotList, iPlots)
  return(plotList)
} # This function is made to be used by mapply(). 'x' - a column from a df; 'colName' - a string specifying the name of this column; 'colNum' - a number specifying the column number of this variable in df

```

## PCA function

```{r PCAFx, echo=FALSE}
PCACompute <- function(df, vars){
  # PCA (see 536 lecture notes week 10) ---------
  rejectVars <- c()
  for(i in vars){
    if(is.numeric(as.matrix(df[[i]])) == FALSE){ # checks that variables are numeric
        rejectVars <- append(rejectVars, i)
    } else {
        mean <- mean(as.matrix(df[i]), na.rm = T)
        sd <- sd(as.matrix(df[i]), na.rm = T)
        
        if(round(mean,4) != 0 || round(sd,4) != 1){ # check if standardized
          df[i] <- scale(df[i])
          # print(c("Not standard.",colnames(df[i]), typeof(as.matrix(df[i])))) 
          # print(c(mean(as.matrix(df[i]), na.rm = T), sd(as.matrix(df[i]), na.rm = T)))
        } else {
          # print(c("Yes.",colnames(df[i]), typeof(as.matrix(df[i]))))   
          # print(c(mean(as.matrix(df[i]), na.rm = T), sd(as.matrix(df[i]),na.rm = T)))
        }
    }
  }
  
  if(length(rejectVars) > 0){
      cat("The following variables are not numeric and cannot be included in PCA. \n\t")
      for(i in colnames(df[rejectVars])){
        cat(i, "\t")
      }
     vars <- vars[vars %in% rejectVars == FALSE] # removes the reject variables from the 'vars' list
  }
  
  out <- prcomp(as.matrix(df[,vars]), center = TRUE, scale = TRUE) # prints output
  return(out)
  
} # 'df' - dataframe; 'vars' - name of vars to conduct PCA on. N.B. these variables must be standardized before being entered here.

PCAPlot <- function(PCAOut, name){
  require(factoextra)
  
  screePlot <- fviz_eig(PCAOut,
                  choice = c("eigenvalue"),
                  geom = c("line"),
                  linecolor = "black",
                  ncp = 10,
                  addlabels = TRUE,
                  hjust = 0,
                  main = paste("Scree plot - ", name),
                  xlab = "Principal component",
                  ylab = NULL) +
              geom_hline(yintercept = 1, linetype = 2)

  return(screePlot)

} # 'PCAOut' - an object of class PCA (i.e., from the PCA compute function); 'name' - name of this PCA analysis

PCAApply <- function(df, PCAOut, componentsToRetain, prefix){
  
  varCols <- which(colnames(df) %in% names(PCAOut$rotation[,1]))
  df_z <- df %>% 
    as_tibble() %>% 
    mutate_at(varCols, ~(scale(.) %>% as.vector))
  
  for(i in 1:componentsToRetain){
    rowName <- paste(prefix, "PC", i, sep="_")
    df_z <- df_z %>% 
      mutate("{{rowName}}" := as.matrix(df_z[varCols]) %*% PCAOut$rotation[,i])
  }
  
  return(df_z)
  
} # Gives each observation a score for each PCA component retained. 'df' - dataframe; 'PCAOut' - output from the PCACompute function; 'componentsToRetain' - an integer value specifying the number of principal components to retain (value must be between 1 and total number of components)); 'prefix' - a character string to be used as a prefix for the new column names.

PCASave <- function(PCAOut, fileName){
  fileName <- paste(fileName, "_", date, ".csv", sep="") 
  capture.output(PCAOut$rotation, file = fileName)
}
  
```

## Compare non-normal vairables
```{r wilcoxTest, echo=FALSE}
runWilcox <- function(varsOfInterest, df, by, fileName){
  require(rcompanion)  
  # wilcoxOutput <- data.frame("value type" = c("statistic","p", "n1", "n2", "r(effSize)"), row.names = 1) # initialize dataframe for the output
  wilcoxOutput <- data.frame("value type" = c("statistic","p", "r(effSize)"), row.names = 1) # initialize dataframe for the output
    i <- integer(0)
    for(i in varsOfInterest){ # iterate through the variables of interest. Run wilcoxon-paired rank test. Put results into a dataframe 
      # print(i)
      x <- as.numeric(unlist(df[i])) # put variable {i} for completers into a temporary vector, make numeric.
      
      wilcoxRaw <- wilcox.test(x ~ unlist(df[by]), alternative = c("two.sided"), paired = F) # run wilcoxon paired-rank
      wilcoxStat <- format(wilcoxRaw$statistic, scientific = T, digits = 3) # Extract W statistic of test. N.b., the 'W' statistic reported here is equivalent to the U statistic: https://stats.stackexchange.com/questions/79843/is-the-w-statistic-output-by-wilcox-test-in-r-the-same-as-the-u-statistic
      wilcoxP <- format(wilcoxRaw$p.value, scientific = T, digits = 3) # Extract P statistic of test
      r <- wilcoxonR(x = x, g = unlist(df[by]))
      wilcoxInterest <- c(wilcoxStat, wilcoxP, r) # combine W statistic, p, n1 and n2 into a vector
      wilcoxOutput[[i]] <- with(wilcoxOutput, wilcoxInterest) # Add the results for variable {i} to the output dataframe
      # print(wilcoxInterest)
      
      # n1 <- length(x) - sum(is.na(x)) # counts number of non-NA values in x
      # n2 <- length(y) - sum(is.na(y)) # counts number of non-NA values in y
      
      # if(n1 <= 1 | n2 <= 1){
      #   print(paste("Not enough observations to compare ", i, ". This variable was skipped."))
      # } else {
      #   wilcoxRaw <- wilcox.test(x, y, alternative = c("two.sided"), paired = F) # run wilcoxon paired-rank
      #   wilcoxStat <- format(wilcoxRaw$statistic, scientific = F, digits = 3) # Extract W statistic of test. N.b., the 'W' statistic reported here is equivalent to the U statistic: https://stats.stackexchange.com/questions/79843/is-the-w-statistic-output-by-wilcox-test-in-r-the-same-as-the-u-statistic
      #   wilcoxP <- format(wilcoxRaw$p.value, scientific = F, digits = 3) # Extract P statistic of test
      #   r <- wilcoxonR()
      #   wilcoxInterest <- c(wilcoxStat, wilcoxP, n1, n2, r) # combine W statistic, p, n1 and n2 into a vector
      #   wilcoxOutput[[i]] <- with(wilcoxOutput, wilcoxInterest) # Add the results for variable {i} to the output dataframe
      #   # print(wilcoxInterest)
      # }
    }
    # return(wilcoxonOutput)
    write.csv(wilcoxOutput, file = glue("{fileName}_{date}.csv")) #exports wilcoxOutput to a CSV file
    print(paste("The Wilcoxon comparison has been saved as:", glue("{fileName}_{date}.csv")))
  } # "varsOfInterest" - list of variable names to compare between groups; "df" data frame with all vars of interest and grouping variable; "by" - grouping variable;
```
# -------------------------------

# 1 - Biobank data analysis

## Data Preperation

```{r removeEIDs, echo=FALSE}
# df_all <- read_csv("/home/doodlefish/Documents/Research/LepageLab/immunologyAndSz/Analysis/immunoCognition-new/data/RawData/Daniel_2022-05-02.csv") # import df
# eidToRemove <- read_csv("/home/doodlefish/Documents/Research/LepageLab/immunologyAndSz/Analysis/immunoCognition-new/data/eidToRemove-w45551_20220222.csv", col_names = "eid") # file with EID of participants who withdrew consent from UKBB
# 
# df_all <- df_all %>% filter(!(eid %in% eidToRemove)) # remove rows with eid in this file
# write.csv(df_all, "/home/doodlefish/Documents/Research/LepageLab/immunologyAndSz/Analysis/immunoCognition-new/data/RawData/Daniel_2022-05-02_ProperEID.csv", row.names=FALSE)
# rm(df_all, eidToRemove) # remove dataframes not in use

```

```{r dataPrep, echo=FALSE}
date <- str_c(format(Sys.time(), "%m"), "_", format(Sys.time(), "%d"), "_", format(Sys.time(), "%Y")) # set todays date for easier output filenaming
df_all <- read_csv("/home/doodlefish/Documents/Research/LepageLab/immunologyAndSz/Analysis/immunoCognition-new/data/RawData/Daniel_2022-05-02_ProperEID.csv", guess_max = 10000) # import df
         
cat(paste("There are ", sum(is.na(df_all$date_assess2_t2)), "cases that have not completed time point 2. These cases will be removed."))
df_all <- df_all %>%
  filter(!(is.na(df_all$date_assess2_t2))) # remove rows without timepoint 2 assessment date

# df_small <- df_all[1:10000,]
df <- df_all # specifies what df to use. In final analyses will want to use df_all but want to use smaller df while developing code.
# rm(df_small) # remove dataframes not in use
# sort(colnames(df))
# View(df)
```

### Standardize categorical vars
```{r standardizeCatVars, echo=FALSE}
# standardize categorical variable responses

df <- df %>% 
  transform(sleep_duration0_t0 = as.character(sleep_duration0_t0)) %>% 
  transform(sleep_duration2_t2 = as.character(sleep_duration2_t2))

df <- df %>%
  mutate(diet_cookedVeg0_t0 = case_when(  # for field: 1289 ('diet_cookedVeg'), -10 = Less than one; -1 = Do not know; -3 = Prefer not to answer;  
      diet_cookedVeg0_t0 == "Less than one" ~ "0.5",       
      diet_cookedVeg0_t0 == "Do not know" ~ "NA",       
      diet_cookedVeg0_t0 == "Prefer not to answer" ~ "NA",
      TRUE ~ diet_cookedVeg0_t0
  )) %>% 
  mutate(diet_cookedVeg2_t2 = case_when(  # for field: 1289 ('diet_cookedVeg'), -10 = Less than one; -1 = Do not know; -3 = Prefer not to answer;  
      diet_cookedVeg2_t2 == "Less than one" ~ "0.5",       
      diet_cookedVeg2_t2 == "Do not know" ~ "NA",       
      diet_cookedVeg2_t2 == "Prefer not to answer" ~ "NA",
      TRUE ~ diet_cookedVeg2_t2
  )) %>% 
  mutate(diet_fruit0_t0 = case_when( # for field: 1309 ('diet_fruit'), -10 = Less than one; -1 = Do not know; -3 = Prefer not to answer;  
      diet_fruit0_t0 == "Less than one" ~ "0.5",       
      diet_fruit0_t0 == "Do not know" ~ "NA",       
      diet_fruit0_t0 == "Prefer not to answer" ~ "NA",
      TRUE ~ diet_fruit0_t0
  )) %>% 
    mutate(diet_fruit2_t2 = case_when( # for field: 1309 ('diet_fruit'), -10 = Less than one; -1 = Do not know; -3 = Prefer not to answer;  
      diet_fruit2_t2 == "Less than one" ~ "0.5",       
      diet_fruit2_t2 == "Do not know" ~ "NA",       
      diet_fruit2_t2 == "Prefer not to answer" ~ "NA",
      TRUE ~ diet_fruit2_t2
  )) %>% 
  mutate(diet_rawVeg_t0 = case_when( # for field: 1299 ('diet_rawVeg'), -10 = Less than one; -1 = Do not know; -3 = Prefer not to answer;
      diet_rawVeg_t0 == "Less than one" ~ "0.5",       
      diet_rawVeg_t0 == "Do not know" ~ "NA",       
      diet_rawVeg_t0 == "Prefer not to answer" ~ "NA",
      TRUE ~ diet_rawVeg_t0
  )) %>%
  mutate(diet_processedMeat0_t0 = case_when( # field 1349 ('diet_processedMeat'), -1 = Do not know; -3 = Prefer not to answer;
      diet_processedMeat0_t0 == "Do not know" ~ "NA",       
      diet_processedMeat0_t0 == "Prefer not to answer" ~ "NA",
      TRUE ~ diet_processedMeat0_t0
  )) %>% 
    mutate(diet_processedMeat2_t2 = case_when( # field 1349 ('diet_processedMeat'), -1 = Do not know; -3 = Prefer not to answer;
      diet_processedMeat2_t2 == "Do not know" ~ "NA",       
      diet_processedMeat2_t2 == "Prefer not to answer" ~ "NA",
      TRUE ~ diet_processedMeat2_t2
  )) %>% 
  mutate(diet_water_t0 = case_when( # field 1528 ('diet_water'), -10 = Less than one; -1 = Do not know; -3 = Prefer not to answer;
      diet_water_t0 == "Less than one" ~ "0.5",       
      diet_water_t0 == "Do not know" ~ "NA",       
      diet_water_t0 == "Prefer not to answer" ~ "NA",
      TRUE ~ diet_water_t0
  )) %>%
  mutate(diet_alc_freq0_t0 = case_when( # field 1558 ('diet_alc_freq'), -3 = Prefer not to answer;
    diet_alc_freq0_t0 == "Prefer not to answer" ~ "NA",
    TRUE ~ diet_alc_freq0_t0 
    )) %>% 
  mutate(diet_alc_freq2_t2 = case_when( # field 1558 ('diet_alc_freq'), -3 = Prefer not to answer;
    diet_alc_freq2_t2 == "Prefer not to answer" ~ "NA",
    TRUE ~ diet_alc_freq2_t2 
    )) %>%
  mutate(menopause0_t0 = case_when( # field 2724 ('menopause'), -3 = Prefer not to answer;
      menopause0_t0 == "Prefer not to answer" ~ "NA",
      TRUE ~ menopause0_t0
  )) %>%
  mutate(menopause2_t2 = case_when( # field 2724 ('menopause'), -3 = Prefer not to answer;
      menopause2_t2 == "Prefer not to answer" ~ "NA",
      TRUE ~ menopause2_t2
  )) %>%
  mutate(sleep_duration0_t0 = case_when( # field 1160 ('sleep_duration'), -1 = Do not know; -3 = Prefer not to answer;
      sleep_duration0_t0 == "Prefer not to answer" ~ "NA",
      sleep_duration0_t0 == "Do not know" ~ "NA",
      TRUE ~ sleep_duration0_t0
  )) %>%
  mutate(sleep_duration2_t2 = case_when( # field 1160 ('sleep_duration'), -1 = Do not know; -3 = Prefer not to answer;
      sleep_duration2_t2 == "Prefer not to answer" ~ "NA",
      sleep_duration2_t2 == "Do not know" ~ "NA",
      TRUE ~ sleep_duration2_t2
  )) %>%
   mutate(smoke_currently0_t0 = case_when( # field 2724 ('smoke_currently'), -3 = Prefer not to answer;
      smoke_currently0_t0 == "Prefer not to answer" ~ "NA",
      smoke_currently0_t0 == "No" ~ smoke_currently0_t0,
      TRUE ~ "Yes"
  )) %>%
  mutate(smoke_currently2_t2 = case_when( # field 2724 ('smoke_currently'), -3 = Prefer not to answer;
      smoke_currently2_t2 == "Prefer not to answer" ~ "NA",
      smoke_currently2_t2 == "No" ~ smoke_currently2_t2,
      TRUE ~ "Yes"
  )) %>%
  mutate(smoke_packYears_t0 = case_when( # field 2724 ('smoke_currently'), -3 = Prefer not to answer;which(colnames(df) == "dx_AnyOfInterest")
      smoke_ever_t0 == "No" ~ 0,
      TRUE ~ smoke_packYears_t0
  )) %>%
  mutate(cog_TMT_numericDuration_t2 =  case_when( # fields: 6348 ('cog_TMT_numericDuration'), 6350 ('cog_TMT_alphanumDuration'), 0 = trail not completed
    cog_TMT_numericDuration_t2 == "trail not completed" ~ "NA",
    TRUE ~ cog_TMT_numericDuration_t2
  )) %>% 
  mutate(cog_TMT_alphanumDuration_t2 =  case_when(
    cog_TMT_alphanumDuration_t2 == "trail not completed" ~ "NA",
    TRUE ~ cog_TMT_alphanumDuration_t2
  )) %>% 
  mutate(cog_numMem_maxDigitRemem_t2 = case_when( # field 4282 ('cog_numMem_maxDigitRemem_t2'), -1 = abandoned
    cog_numMem_maxDigitRemem_t2 == "abandoned" ~ "NA",
    TRUE ~ cog_numMem_maxDigitRemem_t2
  )) %>% 
  mutate(demo_ethnicity_t0 = case_when( # field 4282 ('cog_numMem_maxDigitRemem_t2'), -1 = abandoned
    demo_ethnicity_t0 == "Prefer not to answer" ~ "NA",
    demo_ethnicity_t0 == "Do not know" ~ "NA",
    demo_ethnicity_t0 == "British" ~ "White",
    demo_ethnicity_t0 == "Irish" ~ "White",
    demo_ethnicity_t0 == "Any other white background" ~ "White",
    TRUE ~ "Non White"
     ))

```

### Add columns

```{r addColumns, echo=FALSE}
# Waist:hip ratio -----
df <- df %>% 
  mutate(weight_waistToHip_t0 = weight_waistCirc0_t0/weight_hipCirc0_t0) %>% 
  mutate(weight_waistToHip_t2 = weight_waistCirc2_t2/weight_hipCirc2_t2)

# CRP log transform ------
df <- df %>% 
  mutate(crp_log = log(crp_aliquot_t0))

# Diagnosis - any of interest -----
dxVars <- starts_with("dx_", vars = colnames(df))

df <- df %>% 
  mutate("dx_AnyOfInterest" = factor(case_when(
    if_any(any_of(dxVars), function(x) (x == "TRUE")) ~ 1,
    if_all(all_of(dxVars), function(x) (x == "FALSE")) ~ 0)))
dxVars <- c(dxVars, which(colnames(df) == "dx_AnyOfInterest"))

dxVarsNoCases <- c()
for(i in dxVars){
  if(levels(as.factor(df[i])) == FALSE){
    print(paste("No participant has dx ", colnames(df[i]), "(column ", i, " ); levels: ", levels(as.factor(df[i]))))
    dxVarsNoCases <- append(dxVarsNoCases, i)
  }
}
if(is.null(dxVarsNoCases) == FALSE){
  for(i in dxVarsNoCases){
    dxVars <- dxVars[-which(dxVars == i)]
  }
}
# table(df$anyDx)

# Medication - any of interest -----------
medVars <- starts_with("med_", vars = colnames(df))
# colnames(df[medVars])
medVars0 <- ends_with("t0", vars = colnames(df[medVars]))
medVars0 <- which(colnames(df) %in% colnames(df[medVars[medVars0]]))

medVars2 <- ends_with("t2", vars = colnames(df[medVars]))
medVars2 <- which(colnames(df) %in% colnames(df[medVars[medVars2]]))

medVars0_excludingSSRI <- medVars0[-which(colnames(df[medVars0]) == "med_SSRI_t0")]
medVars2_excludingSSRI <- medVars2[-which(colnames(df[medVars2]) == "med_SSRI_t2")]
df <- df %>% 
  mutate("med_AnyOfInterest0_excludingSSRI" = factor(case_when(
    if_any(any_of(medVars0_excludingSSRI), function(x) (x == "TRUE")) ~ 1,
    if_all(all_of(medVars0_excludingSSRI), function(x) (x == "FALSE")) ~ 0))) %>% 
  mutate("med_AnyOfInterest2_excludingSSRI" = factor(case_when(
    if_any(any_of(medVars2_excludingSSRI), function(x) (x == "TRUE")) ~ 1,
    if_all(all_of(medVars2_excludingSSRI), function(x) (x == "FALSE")) ~ 0)))
medVars0 <- c(medVars0, which(colnames(df) == "med_AnyOfInterest0_excludingSSRI"))
medVars2 <- c(medVars2, which(colnames(df) == "med_AnyOfInterest2_excludingSSRI"))
df <- df %>% 
  mutate("med_AnyOfInterest0" = factor(case_when(
    if_any(any_of(medVars0), function(x) (x == "TRUE")) ~ 1,
    TRUE ~ 0))) %>% 
  mutate("med_AnyOfInterest2" = factor(case_when(
    if_any(any_of(medVars2), function(x) (x == "TRUE")) ~ 1,
    TRUE ~ 0)))

medVars0 <- c(medVars0, which(colnames(df) == "med_AnyOfInterest0"))
medVars2 <- c(medVars2, which(colnames(df) == "med_AnyOfInterest2"))
medVars0NoCases <- c()
for(i in medVars0){
  if(levels(as.factor(df[i])) == FALSE){
    print(paste("No participant takes med ", colnames(df[i]), "; levels: ", levels(as.factor(df[i]))))
    medVars0NoCases <- append(medVars0NoCases, i)
  }
}

medVars2 <- c(medVars2, which(colnames(df) == "med_AnyOfInterest2"))
medVars2NoCases <- c()
for(i in medVars2){
  if(levels(as.factor(df[i])) == FALSE){
    print(paste("No participant takes med ", colnames(df[i]), "; levels: ", levels(as.factor(df[i]))))
    medVars2NoCases <- append(medVars2NoCases, i)
  }
}

if(is.null(medVars0NoCases) == FALSE){
  for(i in medVars0NoCases){
    medVars0 <- medVars0[-which(medVars0 == i)]
  }
}
if(is.null(medVars2NoCases) == FALSE){
  for(i in medVars2NoCases){
    medVars2 <- medVars2[-which(medVars2 == i)]
  }
}
# table(df$anyMed)

# Num days between assessment 2 and assessment 0 ---------
df <- df %>% 
  mutate(demo_daysBtwAssess = as.numeric(df$date_assess2_t2 - df$date_assess0_t0, units = "days"))


# Hour of day of assessments -----------
# Goal: take variables with form: 'YYYY-MM-DDTHH:MM:SS' and return the hour
df <- df %>% 
  mutate(crp_hourCollected = hour(df$crp_timeCollected_t0)) %>% 
  mutate(cog_hourCompleted = hour(df$cog_timeCompleted_t2)) %>% 
  mutate(brain_hourCompleted = hour(df$brain_timeCompleted_t2))

# df <- df %>% mutate(timeDif_brainHourMinusCogHourCompleted = df[124] - df[123]) # number of hours difference between cognitive assessment and MRI
# hourColNums <- c(contains("_hourCompleted", vars = colnames(df)),contains("_hourCollected", vars = colnames(df)))

```

### Make columns appropriate data types

```{r colType, echo=FALSE}
df <- readr::type_convert(df) # automatically detect
factorVars <- which(colnames(df) %in% c("demo_sex_t0", "demo_ethnicity_t0", "cog_prospMem_result_t2", "hand_t0","smoke_currently0_t0", "smoke_currently2_t2", "menopause0_t0", "menopause2_t2", "anyMedOfInterest0", "anyMedOfInterest2", "anyDxOfInterest", colnames(df[dxVars]), colnames(df[medVars0]), colnames(df[medVars2]))) # Factors
# sort(colnames(df[factorVars]))
df[,factorVars] <- lapply(df[,factorVars], factor)

df <- df %>%
  mutate(crp_aliquot_fctr = cut(crp_aliquot_t0, # CRP cutoffs (see Pearson et al., 2003)
                       breaks = c(0,1,3,10),
                       labels = c("Low", "Medium", "High"),
                       include.lowest = T,
                       right = F), .after = crp_aliquot_t0
  ) %>% 
    mutate(cog_prospMem_result_t2 = case_when( # field 20018 ('cog_prospMem_result_t2'), 0 = instruction not recalled, either skipped or incorrect; 1 = correct recall on first attempt; 2 = correct recall on second attempt (as in Cullen et al., 2017)
    cog_prospMem_result_t2 == "correct recall on first attempt" ~ "1",
    cog_prospMem_result_t2 == "NA" ~ "NA",
    TRUE ~ "0" 
    )) %>% mutate(cog_prospMem_result_t2  = as.numeric(cog_prospMem_result_t2))

df <- df %>%
  mutate(smoke_currently0_t0 = factor(smoke_currently0_t0, order = F, levels = c(
                                       "No",
                                       "Yes"))) %>% 
  mutate(smoke_currently2_t2 = factor(smoke_currently2_t2, order = F, levels = c(
                                       "No",
                                       "Yes"))) %>% 
  mutate(diet_processedMeat0_t0 = factor(diet_processedMeat0_t0, order = T, levels = c(
                                       "Never",
                                       "Less than once a week",
                                       "Once a week", 
                                       "2-4 times a week",
                                       "5-6 times a week",
                                       "Once or more daily"))) %>% 
    mutate(diet_processedMeat2_t2 = factor(diet_processedMeat2_t2, order = T, levels = c(
                                       "Never",
                                       "Less than once a week",
                                       "Once a week", 
                                       "2-4 times a week",
                                       "5-6 times a week",
                                       "Once or more daily"))) %>% 
  mutate(diet_alc_freq0_t0 = factor(diet_alc_freq0_t0, order = T, levels = c(
                                       "Never",
                                       "Special occasions only",
                                       "One to three times a month",
                                       "Once or twice a week",
                                       "Three or four times a week",
                                       "Daily or almost daily"))) %>% 
    mutate(diet_alc_freq2_t2 = factor(diet_alc_freq2_t2, order = T, levels = c(
                                       "Never",
                                       "Special occasions only",
                                       "One to three times a month",
                                       "Once or twice a week",
                                       "Three or four times a week",
                                       "Daily or almost daily"))) %>% 
  mutate(exercise_IPAQActivityGroup_t0 = factor(exercise_IPAQActivityGroup_t0, order = T, levels = c(
                                       "low", 
                                       "moderate",
                                       "high"))) %>% 
  mutate(ses_houseIncome0_t0 = factor(ses_houseIncome0_t0, order = T, levels = c(
                                     "Less than 18,000",
                                     "18,000 to 30,999",
                                     "31,000 to 51,999",
                                     "52,000 to 100,000",
                                     "Greater than 100,000"))) %>% 
  mutate(ses_houseIncome2_t2 = factor(ses_houseIncome2_t2, order = T, levels = c(
                                       "Less than 18,000",
                                       "18,000 to 30,999",
                                       "31,000 to 51,999",
                                       "52,000 to 100,000",
                                       "Greater than 100,000"))) %>% 
  mutate(med_SSRI_t0 = factor(case_when(
         med_SSRI_t0 == "FALSE" ~ 0,
         med_SSRI_t0 == "TRUE" ~ 1))) %>% 
  mutate(med_SSRI_t2 = factor(case_when(
         med_SSRI_t2 == "FALSE" ~ 0,
         med_SSRI_t2 == "TRUE" ~ 1))) %>% 
  mutate(med_AnyOfInterest0 = factor(med_AnyOfInterest0)) %>% 
  mutate(med_AnyOfInterest0_excludingSSRI = factor(med_AnyOfInterest0_excludingSSRI)) %>% 
  mutate(med_AnyOfInterest2 = factor(med_AnyOfInterest2)) %>% 
  mutate(med_AnyOfInterest2_excludingSSRI = factor(med_AnyOfInterest2_excludingSSRI))

df$crp_aliquotdelay <- as.duration(interval(df$crp_timeCollected_t0, df$crp_assaydate_t0)) %/% as.duration(months(1))

df <- readr::type_convert(df) # automatically detect
```

### Take mean of covariates measured at both time points
```{r covarCols, echo=FALSE}
df <- df %>% 
  mutate(age_mean02 = (demo_age_assess0_t0 + demo_age_assess2_t2)/2) %>% 
  mutate(weight_waistToHip_mean02 = (weight_waistToHip_t0 + weight_waistToHip_t2)/2) %>%
  mutate(sleep_duration_mean02 = (sleep_duration0_t0 + sleep_duration2_t2)/2)

# cat("Correlations between variables at both time points \n \t age: ",
# cor(df$demo_age_assess0_t0, df$demo_age_assess2_t2, use = "pairwise.complete.obs", method = "spearman"), "\n\t waist-to-hip ratio: ",
# cor(df$weight_waistToHip_t0, df$weight_waistToHip_t2, use = "pairwise.complete.obs", method = "spearman"), "\n\t sleep duration: ", 
# cor(df$sleep_duration0_t0, df$sleep_duration2_t2, use = "pairwise.complete.obs", method = "spearman")
# )
# ggplot(df, aes(x = sleep_duration0_t0, y = sleep_duration2_t2)) +
#   geom_count()

```

### Compute and add lobular brain volumes
```{r computeBrainLobes, echo=FALSE}
vars_BrainRegion <- read_csv("./data/Variables/VariableLists/brainVarsbyLobe.csv")
vars_BrainRegion$varNameDf <- glue("{vars_BrainRegion$VariableName}_t2")

for(lobe in unique(vars_BrainRegion$AssociatedLobe)){
  for(metric_counter in unique(vars_BrainRegion$metric)){
    
    vars_lobe_metric_L <- vars_BrainRegion %>% 
      filter(AssociatedLobe == lobe) %>% 
      filter(metric == metric_counter) %>% 
      filter(hemisphere == "L")
    vars_lobe_metric_R <- vars_BrainRegion %>% 
      filter(AssociatedLobe == lobe) %>% 
      filter(metric == metric_counter) %>% 
      filter(hemisphere == "R")
    
    if(metric_counter == "area"){
      metric_lobe_L <- rowSums(df[vars_lobe_metric_L$varNameDf], na.rm = F)
      metric_lobe_R <- rowSums(df[vars_lobe_metric_R$varNameDf], na.rm = F)
      metric_lobe_WB <- rowSums(data.frame(metric_lobe_L, metric_lobe_R), na.rm = F)
    } else if (metric_counter == "mThick"){
      metric_lobe_L <- rowMeans(df[vars_lobe_metric_L$varNameDf], na.rm = F)
      metric_lobe_R <- rowMeans(df[vars_lobe_metric_R$varNameDf], na.rm = F)
      metric_lobe_WB <- rowMeans(data.frame(metric_lobe_L, metric_lobe_R), na.rm = F)
    } else if (metric_counter == "vol"){
      metric_lobe_L <- rowSums(df[vars_lobe_metric_L$varNameDf], na.rm = F)
      metric_lobe_R <- rowSums(df[vars_lobe_metric_R$varNameDf], na.rm = F)
      metric_lobe_WB <- rowSums(data.frame(metric_lobe_L, metric_lobe_R), na.rm = F)
    } else {
      cat("Error. The metric `", metric_counter, "` defined in the brain variables by brain lobe dataframe is undefined. \n Skipping computation of variables of this metric.")
    }
    tempMatrix <- as.matrix(cbind(metric_lobe_L,metric_lobe_R, metric_lobe_WB))
    colnames(tempMatrix) <- c(glue("{metric_counter}_{lobe}_L_t2"),glue("{metric_counter}_{lobe}_R_t2"),glue("{metric_counter}_{lobe}_WB_t2"))
    df <- cbind(df, as.data.frame(tempMatrix))
  }
}
```

### Save cleaned DF
```{r saveInterimDf, echo=FALSE}
df_interim <- df
save(df_interim, file = "UKBB_dfFormatted_full_05_08_2022.RData")
rm(df_interim)
# load("/home/doodlefish/Documents/Research/LepageLab/immunologyAndSz/Analysis/immunoCognition-new/data/UKBB_dfFormatted_full_05_02_2022.RData")
# df <- df_interim
```

## Remove cases with missing variables
```{r variableLists, echo=FALSE}
demoVars <- starts_with("demo_", vars = colnames(df))
sesVars <- starts_with("ses_", vars = colnames(df))
crpAliqVars <- which(colnames(df) %in% c("crp_aliquot_t0", "crp_log", "crp_aliquot_fctr"))
crpToZ <- which(colnames(df) %in% c("crp_aliquot_t0", "crp_log"))

brainPrefix <- c("area_","gmVol_", "GWcont_","mIntensity","mThick_", "vol_", "weigted_mFA_", "weigted_mICVF_", "weigted_mISOVF_", "weigted_mL1_", "weigted_mL2_", "weigted_mL3_", "weigted_mMD_", "weigted_mMO_", "weigted_mOD_")
brainMorphVars <- c()
for(i in brainPrefix){
  iVars <- starts_with(i, vars = colnames(df))
  # cat(paste(i, ":", length(iVars), "\n"), sep = "")
  brainMorphVars <- c(brainMorphVars, iVars)
}
# length(brainMorphVars)
# sort(colnames(df[brainMorphVars]))
# cor(df$vol_Hippocampus_L_FIRST_t2, df$vol_Hippocampus_L_t2, use = "pairwise.complete.obs")
# colnames(df[demoVars])

dietVars <- starts_with("diet_", vars = colnames(df))
# colnames(df[dietVars])
dietVarsToCor <- which(colnames(df) %in% c("diet_cookedVeg0_t0", "diet_cookedVeg2_t2", "diet_rawVeg_t0", "diet_fruit0_t0", "diet_fruit2_t2", "diet_processedMeat0_t0", "diet_processedMeat2_t2", "diet_water_t0"))

smokingVars <- starts_with("smoke_", vars = colnames(df))
weightVars <- c(starts_with("weight_", vars = colnames(df)), which(colnames(df) == "waistToHip"))
# colnames(df[weightVars])
# cor(df$weight_BMI0_t0, df$weight_BMI2_t2, use = "pairwise.complete.obs")
# cor(df$weight_waistToHip_t0, df$weight_waistToHip_t2, use = "pairwise.complete.obs")

exerciseVars <- starts_with("exercise_", vars = colnames(df))

completionTimeVars <- c(contains("timeCompleted", vars = colnames(df)), contains("timeCollected", vars = colnames(df)))
# colnames(df[completionTimeVars])
# cogPCAVars <- which(colnames(df) %in% c("cog_numMem_maxDigitRemem_t2", "cog_TMT_numericDuration_t2", "cog_TMT_numericErrors_t2", "cog_TMT_alphanumDuration_t2", "cog_TMT_alphanumErrors_t2", "cog_matrix_cor_t2", "cog_reactiontime_mean_t2", "cog_tower_cor_t2", "cog_digsub_cor_t2"))

cogVars <- starts_with("cog", vars = colnames(df))
cogVars_t2 <- cogVars[ends_with("_t2", vars = colnames(df[cogVars]))]
cogVarsToZ <- cogVars_t2[which(!colnames(df[c(cogVars_t2)]) %in% c("cog_prospMem_result_t2", "cog_timeCompleted_t2", "cog_hourCompleted"))]
# colnames(df[cogVarsToZ])

covarsToZ <- which(colnames(df) %in% c("demo_age_assess0_t0", "demo_age_assess2_t2", "age_mean02", "demo_daysBtwAssess", "ses_townsend_t0", "weight_waistToHip_t0", "weight_waistToHip_t2", "weight_waistToHip_mean02", "sleep_duration0_t0", "sleep_duration2_t2", "sleep_duration_mean02"))
varsToZ <- c(crpToZ, cogVarsToZ, covarsToZ)

df_varsToZ <- df[varsToZ] %>% 
  mutate(across(.fns = scale, .names = "{colnames(df[varsToZ])}_z"))
# str(df_varsToZ)
vars_Z <- which(! colnames(df_varsToZ) %in% colnames(df[varsToZ])) # matrix of z-scores made in above line to add to main df\
df <- cbind(df, df_varsToZ[vars_Z])

df$cog_prospMem_result_t2 <- as.factor(df$cog_prospMem_result_t2)

finalCovars <- which(colnames(df) %in% c("demo_sex_t0", "demo_ethnicity_t0", "demo_age_assess0_t0_z", "demo_daysBtwAssess_z", "ses_townsend_t0_z", "weight_waistToHip_mean02_z", "sleep_duration_mean02_z", "exercise_IPAQActivityGroup_t0"))
# sort(colnames(df))
# colnames(df[sesVars])
# View(df[1:100, c(1,cogPCAVars)])
```

```{r removeMissing, echo=FALSE}
essentialVars <- c(finalCovars, completionTimeVars, crpAliqVars, brainMorphVars) # list of variable names that must be complete in order for case to be retained
# load("revisedEssentialVarsAnalysis.RData")
# essentialVars <- essentialVarsAnalysis
# colnames(df[essentialVars])

df <- df %>% 
  mutate(missingEssentialVar = case_when(
    if_any(.cols = essentialVars, function(x)(
      is.na(x))) ~ "Remove",
      TRUE ~ "Keep" )) %>% 
  mutate(missingEssentialVar = factor(missingEssentialVar)) 
# sort(colnames(df))
# table(df$missingEssentialVar)
# table(df$missingEssentialVarsanalysis)

df_removed <- df %>%
  filter(if_any(any_of(essentialVars), function(x)(is.na(x)))) # make new df of cases with missing values

# df <- df %>% 
#   filter(!(eid %in% df_removed$eid)) # remove rows of those with missing values
```

Critical variables: `r colnames(df[essentialVars])` `r nrow(df_removed)` unique cases have missing values for critical variables and will thus be removed.

```{r missingValues, echo=FALSE}
numMissing <- matrix(ncol=2, nrow = length(essentialVars), dimnames = list(colnames(df_removed[essentialVars]), c("NACount", "NotMissingOnThisVar")))

for(i in 1:length(essentialVars)){
  numMissing[i,] <- c(sum(is.na(df_removed[essentialVars[i]])), sum(!is.na(df_removed[essentialVars[i]])))
}

numMissing_df <- as.data.frame(numMissing) %>%  arrange(desc(NACount))

kable(numMissing_df, caption = paste("Number of missing cases per variable. Number of rows with at least one missing value: ", nrow(df_removed), " out of ", sum(df$missingEssentialVar == "Keep")+nrow(df_removed), " total cases (", round(nrow(df_removed)/(sum(df$missingEssentialVar == "Keep")+nrow(df_removed))*100, 2), "%).", sep = ""))
write.csv(numMissing_df, file = paste("UKBB_sourceOfNAValues_", date, ".csv", sep = ""))
```
```{r removeLargeCRP, echo=FALSE}
df_properCRP <- df %>%
  filter(crp_aliquot_t0 <= 10 | is.na(crp_aliquot_t0) == TRUE) # remove CRP > 10
cat(nrow(df) - nrow(df_properCRP), " cases were removed as CRP > 10.", sep = "")
df <- df_properCRP
```

### Normality
```{r normalityInRetained, echo=FALSE}
df_retained <- df %>%
  filter(!(eid %in% df_removed$eid)) # remove rows of those with missing values

varsToCompare <- c("demo_sex_t0", "demo_birthYear_t0", "demo_ethnicity_t0", "demo_age_assess0_t0", "demo_age_assess2_t2", "age_mean02", "ses_townsend_t0", "crp_aliquot_t0", "crp_log", "med_AnyOfInterest0", "med_AnyOfInterest2", "med_AnyOfInterest0_excludingSSRI", "med_AnyOfInterest2_excludingSSRI", "med_SSRI_t0","med_SSRI_t2", "dx_AnyOfInterest", "dx_Dementia", "dx_SSD", "dx_MoodDisorder", "smoke_currently0_t0", "smoke_currently2_t2", "exercise_IPAQActivityGroup_t0", "weight_BMI0_t0","weight_BMI2_t2", "weight_waistToHip_t0","weight_waistToHip_t2","weight_waistToHip_mean02", "diet_processedMeat0_t0", "diet_processedMeat2_t2",  "sleep_duration0_t0", "sleep_duration2_t2", "sleep_duration_mean02", "menopause0_t0", "menopause2_t2", "hand_t0", "crp_hourCollected", "crp_timeFasting_t0", "crp_aliquotdelay", "diet_cookedVeg0_t0", "diet_cookedVeg2_t2", "diet_rawVeg_t0", "diet_fruit0_t0", "diet_fruit2_t2", "diet_water_t0", "diet_alc_freq0_t0", "diet_alc_freq2_t2", "diet_alcohol_yesterdayIntake0_t0", "diet_alcohol_yesterdayIntake2_t2")

varsToCompare_ColNum <- which(colnames(df) %in% varsToCompare)

for(i in c(medVars0NoCases, medVars2NoCases, dxVarsNoCases)){
  if(is.null(i) == FALSE){
    if(i %in% varsToCompare_ColNum){
      colNum <- which(colnames(df) == colnames(df[i]))
      varsToCompare_ColNum <- varsToCompare_ColNum[-which(varsToCompare_ColNum == colNum)]
    }
  }
}

# if("dx_CVD.1" %in% colnames(df[varsToCompare_ColNum])){
#   colNum <- which(colnames(df[varsToCompare_ColNum]) == "dx_CVD.1")
#   varsToCompare_ColNum <- varsToCompare_ColNum[-which(varsToCompare_ColNum == colNum)]
# }

# create list of non-factor numeric variables for normality check ----
numVarsToCompare <- lapply(df[varsToCompare_ColNum], numNotFactor)
df_numVarsToCompare <- as.data.frame(do.call(cbind, numVarsToCompare))
numVarColsToCompare <- (which(colnames(df) %in% colnames(df_numVarsToCompare)))

# For each variable in this list, determine if normal --------
normalityPlots <- mapply(normalCheck, df[c(numVarColsToCompare)], colName = colnames(df[c(numVarColsToCompare)]), colNum = c(numVarColsToCompare))
# N.b. QQ plot should follow a straight line
# nonParametricVars <- c(3,4,5,9,15,16, 17,19,36,38,41,43,49,56,57,58,66,67,69,101) # vector specifying which values of dependent to run non-parametric tests on 
nonParaToCompare <- c(3,10,11,14,15,18,19,20,21,22,25,47,48,49,50,713,719,720,757,763)
```

### Compare removed cases to retained cases

```{r compareMissing, echo=FALSE}
summaryMissing <- list()

runWilcox(colnames(df[nonParaToCompare]), df = df, by = "missingEssentialVar", fileName = "UKBB_compareMissing_wilcox")

# for(i in varsToCompare){
#   if(i %in% nonParaDep == TRUE){
#     nonPara <- i
#   }
#   newRow <- df %>% 
#     summary_factorlist(dependent = i, explanatory = "missingEssentialVar", cont = "median", cont_nonpara = nonPara, p = T, p_cat = "chisq", add_dependent_label = T, add_col_totals = T, add_row_totals = T, na_include = F)
#   # print(newRow)
#   summaryMissing <- c(summaryMissing, newRow)
# }
# capture.output(summaryMissing, file = paste("UKBB_compareMissingCases_", date, ".csv", sep = ""))
# save(summaryMissing, file = paste("UKBB_compareMissingCases", date, ".csv"))

# sum(!is.na(df$diet_alcohol_yesterdayIntake_t0))
# median(df$diet_alcohol_yesterdayIntake_t0, na.rm = T)
# IQR(df$diet_alcohol_yesterdayIntake_t0, na.rm = T)
# median(df_retained$diet_alcohol_yesterdayIntake_t0, na.rm = T)
# IQR(df_retained$diet_alcohol_yesterdayIntake_t0, na.rm = T)
# median(df_removed$diet_alcohol_yesterdayIntake_t0, na.rm = T)
# IQR(df_removed$diet_alcohol_yesterdayIntake_t0, na.rm = T)
# 
# sum(!is.na(df$demo_daysBtwAssess))
# mean(df$demo_daysBtwAssess, na.rm = T)
# sd(df$demo_daysBtwAssess, na.rm = T)
# mean(df$demo_daysBtwAssess, na.rm = T)
# sd(df_retained$demo_daysBtwAssess, na.rm = T)
# mean(df_removed$demo_daysBtwAssess, na.rm = T)
# sd(df_removed$demo_daysBtwAssess, na.rm = T)
# t.test(df$demo_daysBtwAssess, group = df$missingEssentialVar)

comparisonDroppedCases <- TOne(df[varsToCompare], grp = df$missingEssentialVar, add.length = T, total = T, 
          FUN = function(x) gettextf("%s (%s); %s (%s)",
            Format(mean(x, na.rm = T), digits = 2, big.mark = ","),
            Format(sd(x, na.rm = T), digits = 2, big.mark = ","),
            Format(median(x, na.rm = T), digits = 2, big.mark = ","),
            Format(IQR(x, na.rm = T), digits = 2, big.mark = ",")),
          TEST = list(
            num  = list(fun = function(x, g){paste(
                                                  "F(", 
                                                    summary(aov(x ~ g))[[1]][1, "Df"], ",",
                                                    summary(aov(x ~ g))[[1]][2, "Df"], ") = ", 
                                                  formatC(summary(aov(x ~ g))[[1]][1, "F value"], digits = 5), 
                                                  ", p = ", formatC(summary(aov(x ~ g))[[1]][1, "Pr(>F)"], format = "g", digits = 3), 
                                                  ", g = ", formatC(effsize::cohen.d(x ~ g, data = df, pooled = T, hedges.correction = T)$estimate, format = "g", digits = 3), # calculate g. See Durlak 2009, J. Ped. Psyc.
                                                  sep = "")},
                        lbl = "ANOVA"),
            cat  = list(fun = function(x, g){paste(
                                                  "χ²(", chisq.test(table(x, g))$parameter, ") = ", 
                                                  formatC(chisq.test(table(x, g))$statistic, digits = 5), 
                                                  ", p = ", formatC(chisq.test(table(x, g))$p.val, format = "g", digits = 3),
                                                  ", v = ", formatC(sqrt(chisq.test(table(x, g))$statistic)/(length(x)*chisq.test(table(x, g))$parameter), format = "g", digits = 2), 
                                                  sep = "")},
                        lbl = "Chi-Square test"),
            dich = list(fun = function(x, g){paste(
                                                  "χ²(", chisq.test(table(x, g))$parameter, ") =", 
                                                  formatC(chisq.test(table(x, g))$statistic, digits = 2), 
                                                  ", p = ",  formatC(chisq.test(table(x, g))$p.val, format = "g", digits = 3), 
                                                  ", v = ", formatC(sqrt(chisq.test(table(x, g))$statistic)/(length(x)*chisq.test(table(x, g))$parameter), format = "g", digits = 2), 
                                                  sep = "")},
                        lbl = "Chi-Square test")), 
          fmt = list(abs  = Fmt("abs"), 
             num  = Fmt("num"), 
             per  = Fmt("per"),
             pval = as.fmt(fmt = "p*")))

write.csv(comparisonDroppedCases, file = paste("UKBB_compareMissingCases_TOne", date, ".csv", sep = ""))
kable(comparisonDroppedCases)

```

### Summarise
```{r saveDf, echo=FALSE}
df <- df_retained
write.csv(df_retained, file = paste("UKBB_dfRetained_", date, ".csv", sep = "")) # exports wilcoxOutput to a CSV file
write.csv(psych::describe(df), file = glue("UKBB_describedRetainedCases_{date}.csv")) # exports wilcoxOutput to a CSV file
varsToSummarise <- c(1:ncol(df))
  
numVars<- lapply(df, numNotFactor)
df_numVars <- as.data.frame(do.call(cbind, numVars))
numVarCols <- (which(colnames(df) %in% colnames(df_numVars)))
numVars <- c((which(colnames(df) %in% colnames(df_numVars))), which(colnames(df) == "date_assess0_t0"), which(colnames(df) == "date_assess2_t2"), which(colnames(df) == "cog_timeCompleted_t2"), which(colnames(df) == "brain_timeCompleted_t2"), which(colnames(df) == "crp_timeCollected_t0"), which(colnames(df) == "crp_assaydate_t0"))

for(i in c(medVars0NoCases, medVars2NoCases, dxVarsNoCases)){
  if(is.null(i) == FALSE){
    if(i %in% varsToSummarise){
      colNum <- which(colnames(df) == colnames(df[i]))
      varsToSummarise <- varsToSummarise[-which(varsToSummarise == colNum)]
    }
  }
}

write.csv(describeBy(df[numVars], group = df$crp_aliquot_fctr)[1], file = paste("UKBB_dfRetained_Summary_byCRP_numVars_", names(describeBy(df, group = df$crp_aliquot_fctr)[1]), "_", date, ".csv", sep = "")) # save counts of categorical variables
write.csv(summary(df[-numVars]), file = paste("UKBB_dfRetained_Summary_fctrVars", date, ".csv", sep = "")) # save counts of categorical variables

write.csv(describeBy(df[numVars], group = df$crp_aliquot_fctr)[1], file = paste("UKBB_dfRetained_Summary_byCRP_numVars_", names(describeBy(df, group = df$crp_aliquot_fctr)[1]), "_", date, ".csv", sep = "")) # save counts of categorical variables
write.csv(describeBy(df[numVars], group = df$crp_aliquot_fctr)[2], file = paste("UKBB_dfRetained_Summary_byCRP_numVars_", names(describeBy(df, group = df$crp_aliquot_fctr)[2]), "_", date, ".csv", sep = "")) # save counts of categorical variables
write.csv(describeBy(df[numVars], group = df$crp_aliquot_fctr)[3], file = paste("UKBB_dfRetained_Summary_byCRP_numVars_", names(describeBy(df, group = df$crp_aliquot_fctr)[3]), "_", date, ".csv", sep = "")) # save counts of categorical variables

# capture.output(Hmisc::describe(df[-numVars]), file = paste("UKBB_dfRetained_Summary_fctrVars", date, ".tex", sep = "")) # save counts of categorical variables to latex file

## Error in below description: !!!!
# comparisonCRPFctr <- TOne(df[varsToSummarise], grp = df$crp_aliquot_fctr, add.length = T, colnames = colnames(df[varsToSummarise]), total = T, # need to find which categorical variable is causing an error here. colnames(df[! colnames(df[varsToSummarise]) %in% colnames(df[varsToCompare])])
#      FUN = function(x) gettextf("%s (%s); %s (%s)",
#             Format(mean(x, na.rm = T), digits = 3),
#             Format(sd(x, na.rm = T), digits = 3),
#             Format(median(x, na.rm = T), digits = 3),
#             Format(IQR(x, na.rm = T), digits = 3)),
#      TEST = list(
#             num  = list(fun = function(x, g){paste(
#                                                     "F(", summary(aov(x ~ g))[[1]][1, "Df"],",", summary(aov(x ~ g))[[1]][2, "Df"], ") = ", formatC(summary(aov(x ~ g))[[1]][1, "F value"], digits = 5), 
#                                                     " p = ", formatC(summary(aov(x ~ g))[[1]][1, "Pr(>F)"], format = "g", digits = 3), sep = "")},
#                         lbl = "ANOVA"),
#             cat  = list(fun = function(x, g){paste(
#                                                   "chisq(", chisq.test(table(x, g))$parameter, ") =", 
#                                                    formatC(chisq.test(table(x, g))$statistic, digits = 5), 
#                                                    "p = ",  formatC(chisq.test(table(x, g))$p.val, format = "g", digits = 3), sep = " ")},
#                         lbl = "Chi-Square test"),
#             dich = list(fun = function(x, g){paste(
#                                                   "chisq(", chisq.test(table(x, g))$parameter, ") =", 
#                                                    formatC(chisq.test(table(x, g))$statistic, digits = 5), 
#                                                    "p = ",  formatC(chisq.test(table(x, g))$p.val, format = "g", digits = 3), sep = " ")},
#                         lbl = "Chi-Square test")), 
#           fmt = list(abs  = Fmt("abs"), 
#              num  = Fmt("num"), 
#              per  = Fmt("per"),
#              pval = as.fmt(fmt = "p*")))
# !!!!!
# write.csv(comparisonCRPFctr, file = paste("UKBB_compareCRPLevels_TOne", date, ".csv", sep = ""))
# kable(comparisonCRPFctr)

# numVars <- c((which(colnames(df) %in% colnames(df_numVars))), which(colnames(df) == "date_assess0_t0"), which(colnames(df) == "date_assess2_t2"), which(colnames(df) == "cog_timeCompleted_t2"), which(colnames(df) == "brain_timeCompleted_t2"), which(colnames(df) == "crp_timeCollected_t0"), which(colnames(df) == "crp_assaydate_t0"))
# df_retained <- read_csv("/home/doodlefish/Documents/Research/LepageLab/immunologyAndSz/Analysis/immunoCognition/UKBB_dfRetained_03_21_2022.csv", guess_max = 10000) # import df
# df <- df_retained
```

# Subset and Save DF
```{r subsetDF, echo=FALSE}
df <- read_csv("/home/doodlefish/Documents/Research/LepageLab/immunologyAndSz/Analysis/immunoCognition-new/data/forAnalysis/UKBB_dfForAnal_All_05_05_2022.csv", lazy = T)

# save dataframe for analyses
fileName <- paste("UKBB_dfForAnal_All_", date, sep = "")
write.csv(df, file = glue("{fileName}.csv")) # exports cleaned dataframe with all variables ready for analysis
save(df, file = glue("{fileName}.RData"))

# Make different data subsets:
# Demographics
df_oldest <- df %>% filter(df$demo_age_assess0_t0 >= quantile(df$demo_age_assess0_t0, c(.66))) # keeps only oldest participants (in top tertile of age)
fileName <- paste("UKBB_dfForAnal_oldestTert_", date, ".csv", sep = "")
write.csv(df_oldest, file = fileName)
cat("Subset with oldest tertile of participants saved as: `", fileName, "`. \n\t complete cases: ", nrow(df_oldest), "\n\t age range: ", range(df_oldest$demo_age_assess0_t0))
rm(df_oldest)

df_youngest <- df %>% filter(df$demo_age_assess0_t0 <= quantile(df$demo_age_assess0_t0, c(.33))) # keeps only youngest participants (in bottom tertile of age)
fileName <- paste("UKBB_dfForAnal_youngestTert_", date, ".csv", sep = "")
write.csv(df_youngest, file = fileName)
cat("Subset with youngest tertile of participants saved as: `", fileName, "`. \n\t complete cases: ", nrow(df_youngest), "\n\t age range: ", range(df_youngest$demo_age_assess0_t0))
rm(df_youngest)

# Diagnoses
# summary(df$dx_AnyOfInterest)
df_noDx <- df %>% filter(dx_AnyOfInterest == 0) # remove participants with diagnoses from dataframe 
fileName <- paste("UKBB_dfForAnal_excludingDx_", date, ".csv", sep = "")
write.csv(df_noDx, file = fileName)
cat("Subset excluding those using medication of interest saved as: `", fileName, "`. \n\t complete cases: ", nrow(df_noDx))

df_onlyDx <- df %>% filter(dx_AnyOfInterest == 1) # remove participants without diagnoses from dataframe 
fileName <- paste("UKBB_dfForAnal_onlyDx_", date, ".csv", sep = "")
write.csv(df_onlyDx, file = fileName)
cat("Subset of only those using medication of interest saved as: `", fileName, "`. \n\t complete cases: ", nrow(df_onlyDx))
rm(df_onlyDx)

# Medications
table(df$med_SSRI_t0, df$med_SSRI_t2)
df_noSSRI <- df %>% filter(med_SSRI_t0 == "0") %>%  filter(med_SSRI_t2 == "0") # remove participants taking meds from dataframe 
fileName <- paste("UKBB_dfForAnal_excludingSSRI_", date, ".csv", sep = "")
write.csv(df_noSSRI, file = fileName)
cat("Subset excluding those using SSRIs saved as: `", fileName, "`. \n\t complete cases: ", nrow(df_noSSRI))
rm(df_noSSRI)

df_onlySSRI <- df %>% filter(med_SSRI_t0 == 1 || med_SSRI_t2 == 1) # keep participants taking SSRIs 
write.csv(df_onlySRRI, file = paste("UKBB_dfForAnal_onlySSRIUsers", date, ".csv", sep = ""))
rm(df_onlySRRI)

df_onlyMedUsers_a <- df %>% filter(med_AnyOfInterest0 == 1) # remove participants not taking meds from dataframe 
df_onlyMedUsers_b <- df %>% filter(med_AnyOfInterest2 == 1) # remove participants not taking meds from dataframe 
df_onlyMedUsers <- distinct(rbind(df_onlyMedUsers_a, df_onlyMedUsers_b))
fileName <- paste("UKBB_dfForAnal_onlyMedUsers_", date, ".csv", sep = "")
write.csv(df_onlyMedUsers, file = fileName)
cat("Subset only of those using any mediucation of interest (including SSRIs) saved as: `", fileName, "`. \n\t complete cases: ", nrow(df_onlyMedUsers))
rm(df_onlyMedUsers)

df_noMed <- df %>% filter(med_AnyOfInterest0 == 0) %>% filter(med_AnyOfInterest2 == 0)  
fileName <- paste("UKBB_dfForAnal_noMed_", date, ".csv", sep = "")
write.csv(df_noMed, file = fileName)
cat("Subset excluding those using medications of interest saved as: `", fileName, "`. \n\t complete cases: ", nrow(df_noMed))
rm(df_noMed)

# Remove diagnoses and medications
df_noMed_noDx <- df_noDx %>% filter(med_AnyOfInterest0 == 0) %>% filter(med_AnyOfInterest2 == 0) # remove participants taking meds from dataframe 
fileName <- paste("UKBB_dfForAnal_NoMedNoDx_", date, ".csv", sep = "")
write.csv(df_noMed_noDx, file = fileName)
cat("Subset excluding those using medications or with a diangnosis of interest saved as: `", fileName, "`. \n\t complete cases: ", nrow(df_noMed_noDx))
rm(df_noMed_noDx)

df_noSSRI_noDx <- df_noDx %>% filter(med_SSRI_t0 == "0") %>%  filter(med_SSRI_t2 == "0") # remove participants taking SSRIs from dataframe 
fileName <- paste("UKBB_dfForAnal_NoDxNoSSRI_", date, ".csv", sep = "")
write.csv(df_noSSRI_noDx, file = fileName)
cat("Subset excluding those using SSRIs or with a diagnosis of interest saved as: `", fileName, "`. \n\t complete cases: ", nrow(df_noSSRI_noDx))
rm(df_noMed_noDx)


# table(df$med_AnyOfInterest0_excludingSSRI, df$med_AnyOfInterest2_excludingSSRI)
# df_noMedOtherThanSSRI <- df %>% filter(med_AnyOfInterest0_excludingSSRI == "0") %>% filter(med_AnyOfInterest2_excludingSSRI == "0") # remove participants taking meds from dataframe 
# fileName <- paste("UKBB_dfForAnal_excludingAllMed_", date, ".csv", sep = "")
# write.csv(df_noMed, file = fileName)
# cat("Subset excluding those using any mediucation of interest (including SSRIs) saved as: `", fileName, "`. \n\t complete cases: ", nrow(df_noMed))
# rm(df_noMed)

```
## Describe Subsets
```{r DesciurbeSubsets, echo=FALSE}
path <- "/home/doodlefish/Documents/Research/LepageLab/immunologyAndSz/Analysis/immunoCognition-new/data/forAnalysis/Subsets"
fileNames <- c("UKBB_dfForAnal_excludingDx_05_08_2022","UKBB_dfForAnal_excludingSSRI_05_04_2022","UKBB_dfForAnal_noMed_05_08_2022","UKBB_dfForAnal_NoMedNoDx_05_08_2022","UKBB_dfForAnal_NoSSRINoDx_05_08_2022","UKBB_dfForAnal_oldestTert_05_04_2022","UKBB_dfForAnal_onlyDx_05_04_2022","UKBB_dfForAnal_onlyMedUsers_05_04_2022","UKBB_dfForAnal_youngestTert_05_04_2022")

for(file in fileNames){
  fileName <- glue("{path}/{file}.csv")
  subset_df <- read_csv(fileName, lazy = T, show_col_types = F)
  subsetName <- unlist(strsplit(file, "_"))[3]
  print(subsetName)
  write.csv(psych::describe(subset_df), file = glue("Described_{subsetName}_{date}.csv")) # exports wilcoxOutput to a CSV file
}


```

# Varia correlations
## Correl of CRP vars 
```{r correlCRPVars, echo=FALSE}
print("Hour collected")
median(hour(df$crp_timeCollected_t0), na.rm = T)
iqr(hour(df$crp_timeCollected_t0), na.rm = T)
cat("Correlation between CRP and hour collected: ")
cor.test(rank(df$crp_aliquot_t0), rank(hour(df$crp_timeCollected_t0)), na.action = na.omit, conf.level = .95)

print("Fasting time")
median(df$crp_timeFasting_t0, na.rm = T)
iqr(df$crp_timeFasting_t0)
cat("Correlation between CRP and hours fasted before blood draw: ")
cor.test(rank(df$crp_aliquot_t0), rank(df$crp_timeFasting_t0), na.action = na.omit)

cat("CRP aliquots were performed between", paste(min(df$crp_assaydate_t0))," and ", paste(max(df$crp_assaydate_t0)))
df$crp_assaydate_t0 <- as.POSIXct(df$crp_assaydate_t0)

cat("the mean time between blood sample and CRP measurement was (in years): \n\t", "mean:", mean(df$crp_aliquotdelay, na.rm = T), "SD: ", sd(df$crp_aliquotdelay, na.rm = T), "\n\t Median: ", median(df$crp_aliquotdelay, na.rm = T), "IQR: ", iqr(df$crp_aliquotdelay))

cor.test(rank(df$crp_aliquotdelay), rank(df$crp_aliquot_t0))
```

## Correlations between diet variables

```{r correlDietVars, echo=FALSE}
# diet_numeric <- c()
# for(i in dietVarsToCor){
#   if(is.numeric(df[[i]]) == T){
#     diet_numeric <- append(diet_numeric,i)
#   } 
# }
# 
# out <- matrix(ncol = 6, dimnames = list(c(),c("x,y","rho","p","stat", "nx", "ny"))) # initilaize output matrix
# VarsDone <- c()
# for(i in diet_numeric){
#   VarsDone <- append(VarsDone, i)
#   for(j in diet_numeric){
#     if(i != j){
#         test <- cor.test(df[[i]], df[[j]], method = 'spearman')
#         corName <- paste(colnames(df[i]), ", ", colnames(df[j]), sep = "")
#         nx <- length(df[[i]]) - sum(is.na(df[[i]]))
#         ny <- length(df[[j]]) - sum(is.na(df[[j]]))
#         newRow <- c(corName,format(round(test$estimate, 5), nsmall = 5), format(round(test$p.value, 2), scientific = T), format(round(test$statistic, 2),scientific = T), nx, ny)
#         out <- rbind(out, {newRow})
#       }
#   }
#   test <- cor.test(rank(df$diet_processedMeat_t0), rank(df[[i]]), method = 'pearson')
#   corName <- paste("diet_processedMeat_t0,", colnames(df[i]), sep = "")
#   nx <- length(df$diet_processedMeat_t0) - sum(is.na(df$diet_processedMeat_t0))
#   ny <- length(df[[i]]) - sum(is.na(df[[i]]))
#   newRow <- c(corName,format(round(test$estimate, 5), nsmall = 5), format(round(test$p.value, 2), scientific = T), format(round(test$statistic, 2), scientific = T), nx, ny)
#   out <- rbind(out, {newRow})
# }
#   test <- cor.test(rank(df$diet_processedMeat_t0), rank(df$diet_cookedVeg_t0), method = 'pearson')
#   corName <- paste("diet_processedMeat_t0, diet_cookedVeg_t0")
#   nx <- length(df$diet_processedMeat_t0) - sum(is.na(df$diet_processedMeat_t0))
#   ny <- length(df$diet_cookedVeg_t0) - sum(is.na(df$diet_cookedVeg_t0))
#   newRow <- c(corName,format(round(test$estimate, 5), nsmall = 5), format(round(test$p.value, 2), scientific = T), format(round(test$statistic, 2), scientific = T), nx, ny)
#   out <- rbind(out, {newRow})
#   
#   test <- cor.test(rank(df$diet_processedMeat_t0), rank(df$diet_rawVeg_t0), method = 'pearson')
#   corName <- paste("diet_processedMeat_t0, diet_rawVeg_t0")
#   nx <- length(df$diet_processedMeat_t0) - sum(is.na(df$diet_processedMeat_t0))
#   ny <- length(df$diet_rawVeg_t0) - sum(is.na(df$diet_rawVeg_t0))
#   newRow <- c(corName,format(round(test$estimate, 5), nsmall = 5), format(round(test$p.value, 2), scientific = T), format(round(test$statistic, 2), scientific = T), nx, ny)
#   out <- rbind(out, {newRow})
#   
#   test <- cor.test(rank(df$diet_processedMeat_t0), rank(df$diet_water_t0), method = 'pearson')
#   corName <- paste("diet_processedMeat_t0, diet_water_t0")
#   nx <- length(df$diet_processedMeat_t0) - sum(is.na(df$diet_processedMeat_t0))
#   ny <- length(df$diet_water_t0) - sum(is.na(df$diet_water_t0))
#   newRow <- c(corName,format(round(test$estimate, 5), nsmall = 5), format(round(test$p.value, 2), scientific = T), format(round(test$statistic, 2), scientific = T), nx, ny)
#   out <- rbind(out, {newRow})
# 
# out <- out[-1,] # removes first column which is "NA"
# out <- out[order(out[,2], decreasing = T),]
# out <- out[-(seq(2,to=nrow(out),by=2)),]
# kable(out, caption = "Spearman correlation between diet variables")

```

```{r printRSessionInfo, echo=FALSE}
sessionInfo()
capture.output(sessionInfo(), file = paste("UKBB_rSessionInfo_DataPrep_", date, ".csv", sep = ""))
```
